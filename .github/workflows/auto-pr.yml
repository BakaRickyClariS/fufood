name: Auto PR by Branch Naming

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pull-requests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch origin

      - name: Find unmerged branches
        id: branches
        run: |
          BRANCHES=$(git branch -r --no-merged origin/dev | grep -v origin/dev | grep -v origin/main | grep -v origin/qa | sed 's|origin/||')
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCHES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Requests
        if: steps.branches.outputs.list != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const branches = `${{ steps.branches.outputs.list }}`.trim().split('\n').filter(b => b);

            function formatTitle(branch) {
              return branch
                .replace(/^Feature-/, '').replace(/^Fix-/, '').replace(/^Update-/, '').replace(/^Hotfix-/, '')
                .replace(/-/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase())
                .trim();
            }

            function getLabels(branch) {
              if (branch.startsWith('Feature-')) return ['feature', 'enhancement'];
              if (branch.startsWith('Fix-')) return ['bug', 'fix'];
              if (branch.startsWith('Update-')) return ['documentation', 'update'];
              if (branch.startsWith('Hotfix-')) return ['hotfix', 'urgent'];
              return [];
            }

            for (const branch of branches) {
              const title = formatTitle(branch);
              const labels = getLabels(branch);
              
              for (const base of ['qa', 'dev']) {
                try {
                  const prTitle = `[${base.toUpperCase()}] ${title}`;
                  const pr = await github.rest.pulls.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    head: branch,
                    base: base,
                    title: prTitle,
                    body: `Auto-created PR from branch: ${branch}`
                  });
                  
                  if (labels.length > 0) {
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: pr.data.number,
                      labels: labels
                    });
                  }
                  
                  console.log(`Created ${base.toUpperCase()} PR #${pr.data.number}`);
                } catch (error) {
                  console.log(`Error creating ${base} PR: ${error.message}`);
                }
              }
            }
