name: Auto PR to Dev

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pull-requests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch origin

      - name: Create Pull Requests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const { execSync } = require('child_process');

            // 獲取所有未合併至 dev 的分支
            let unmergedBranches = [];
            try {
              const output = execSync('git branch -r --no-merged origin/dev | grep -v origin/dev | grep -v origin/main | grep -v origin/qa | sed "s|origin/||"', { encoding: 'utf-8' })
                .trim();
              unmergedBranches = output.split('\n').filter(b => b && b.length > 0);
            } catch (e) {
              console.log('No unmerged branches found or error occurred');
              unmergedBranches = [];
            }

            console.log(`Found ${unmergedBranches.length} unmerged branches`);

            for (const branch of unmergedBranches) {
              console.log(`\n========== Processing branch: ${branch} ==========`);
              
              try {
                // Step 1: Fetch remote branch with proper error handling
                console.log(`Fetching ${branch}...`);
                try {
                  execSync(`git fetch origin "${branch}" --depth=1`, { 
                    stdio: 'pipe',
                    encoding: 'utf-8'
                  });
                  console.log(`✅ Successfully fetched ${branch}`);
                } catch (fetchError) {
                  console.log(`⚠️ Warning: Failed to fetch ${branch}: ${fetchError.message}`);
                  continue;
                }
                
                // Step 2: Get commits with proper error handling
                let commits = '';
                try {
                  console.log(`Getting commits for ${branch}...`);
                  commits = execSync(`git log origin/dev..origin/${branch} --pretty=format:"- %s" --reverse`, { 
                    stdio: 'pipe',
                    encoding: 'utf-8'
                  }).trim();
                  
                  if (!commits) {
                    commits = 'No commit messages available';
                  }
                  console.log(`✅ Got commits: ${commits.split('\n').length} entries`);
                } catch (logError) {
                  console.log(`⚠️ Warning: Failed to get commits for ${branch}: ${logError.message}`);
                  commits = 'No commit messages available';
                }
                
                // Step 3: Determine labels based on branch name
                let labels = [];
                if (branch.startsWith('Feature-')) {
                  labels = ['feature', 'enhancement'];
                } else if (branch.startsWith('Fix-')) {
                  labels = ['bug', 'fix'];
                } else if (branch.startsWith('Update-')) {
                  labels = ['documentation', 'update'];
                } else if (branch.startsWith('Hotfix-')) {
                  labels = ['hotfix', 'urgent'];
                }
                
                const prBody = `## Commits\n\n${commits || 'No commit messages available'}\n\n## Testing\n\n- [ ] Tested in QA environment\n- [ ] Functionality working correctly\n- [ ] No critical bugs`;
                
                // Step 4: Check if PR already exists
                console.log(`Checking for existing PR...`);
                let prExists = false;
                try {
                  const existingPrs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    head: `${context.repo.owner}:${branch}`,
                    base: 'dev',
                    state: 'open'
                  });
                  
                  if (existingPrs.data && existingPrs.data.length > 0) {
                    console.log(`⚠️ PR already exists for ${branch} -> dev (PR #${existingPrs.data[0].number})`);
                    prExists = true;
                  }
                } catch (checkError) {
                  console.log(`⚠️ Could not check for existing PR: ${checkError.message}`);
                }
                
                if (prExists) {
                  continue;
                }
                
                // Step 5: Create PR
                console.log(`Creating PR for ${branch} -> dev...`);
                try {
                  const pr = await github.rest.pulls.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    head: branch,
                    base: 'dev',
                    title: branch,
                    body: prBody
                  });
                  
                  console.log(`✅ Created PR #${pr.data.number}: ${pr.data.title}`);
                  
                  // Step 6: Add labels if any
                  if (labels.length > 0) {
                    try {
                      await github.rest.issues.addLabels({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: pr.data.number,
                        labels: labels
                      });
                      console.log(`✅ Added labels: ${labels.join(', ')}`);
                    } catch (labelError) {
                      console.log(`⚠️ Warning: Failed to add labels: ${labelError.message}`);
                    }
                  }
                  
                } catch (prError) {
                  // Check if it's a "already exists" error
                  if (prError.message && (prError.message.includes('already exists') || prError.message.includes('pull request already exists'))) {
                    console.log(`⚠️ PR already exists for ${branch} -> dev`);
                  } else {
                    console.log(`❌ Error creating PR for ${branch}: ${prError.message}`);
                  }
                }
                
              } catch (error) {
                console.log(`❌ Unexpected error processing ${branch}: ${error.message}`);
              }
            }

            console.log('\n========== Workflow completed ==========');
