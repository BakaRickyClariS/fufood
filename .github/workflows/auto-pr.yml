name: Auto PR by Branch Naming

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  batch-pr-auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          fetch-depth: 0

      - name: Fetch all remote branches
        run: git fetch origin

      - name: Find unmerged branches
        id: list
        shell: bash
        run: |
          BRANCHES=$(git branch -r --no-merged origin/dev | grep -v "origin/dev" | grep -v "origin/main" | grep -v "origin/qa" | sed 's|origin/||')
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "üß≠ Unmerged branches:"
          echo "$BRANCHES"

      - name: Create QA and DEV Pull Requests with Auto Labels
        if: steps.list.outputs.branches != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const branches = `${{ steps.list.outputs.branches }}`.split('\n').filter(Boolean);

            console.log(`üß© Found ${branches.length} branches to process`);

            function formatTitle(branch) {
              const cleaned = branch.replace(/^Feature-/, '')
                .replace(/^Fix-/, '')
                .replace(/^Update-/, '')
                .replace(/^Hotfix-/, '')
                .replace(/-/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase());
              return cleaned.trim();
            }

            function getLabels(branch) {
              const labels = [];
              
              if (branch.startsWith('Feature-')) {
                labels.push('feature', 'enhancement');
              } else if (branch.startsWith('Fix-')) {
                labels.push('bug', 'fix');
              } else if (branch.startsWith('Update-')) {
                labels.push('documentation', 'update');
              } else if (branch.startsWith('Hotfix-')) {
                labels.push('hotfix', 'urgent');
              }
              
              return labels;
            }

            for (const branch of branches) {
              const title = formatTitle(branch);
              const qaTitle = `[QA] ${title}`;
              const devTitle = `[DEV] ${title}`;
              const labels = getLabels(branch);
              
              console.log(`üöÄ Creating PRs for: ${branch} ‚Üí ${title}`);
              console.log(`üè∑Ô∏è Labels: ${labels.join(', ')}`);

              // Âª∫Á´ã QA PR
              try {
                const qaPr = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: branch,
                  base: "qa",
                  title: qaTitle,
                  body: `## üß© ÂäüËÉΩÊëòË¶Å\n\nËá™ÂãïÂª∫Á´ã QA Ê∏¨Ë©¶Áî® PR\n\n**‰æÜÊ∫êÂàÜÊîØÔºö** ${branch}\n\n## üß™ Ê∏¨Ë©¶È†ÖÁõÆ\n\n- [ ] ÂäüËÉΩÂèØÂú® Vercel QA Áí∞Â¢ÉÊ≠£Â∏∏ÈÅã‰Ωú\n\n## üìé ÂÇôË®ª\n\nÊ≠§ PR ÁÇ∫Ëá™ÂãïÂª∫Á´ãÁöÑÊ∏¨Ë©¶ÁâàÊú¨`
                });
                
                // ÁÇ∫ QA PR Ê∑ªÂä† labels
                if (labels.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: qaPr.data.number,
                    labels: labels
                  });
                  console.log(`‚úÖ QA PR #${qaPr.data.number} created with labels: ${labels.join(', ')}`);
                } else {
                  console.log(`‚úÖ QA PR #${qaPr.data.number} created`);
                }
              } catch (err) {
                console.log(`‚ö†Ô∏è QA PR skipped for ${branch}: ${err.message}`);
              }

              // Âª∫Á´ã DEV PR
              try {
                const devPr = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: branch,
                  base: "dev",
                  title: devTitle,
                  body: `## üß© ÂäüËÉΩÊëòË¶Å\n\nËá™ÂãïÂª∫Á´ã DEV Êï¥ÂêàÁî® PR\n\n**‰æÜÊ∫êÂàÜÊîØÔºö** ${branch}\n\n## üß™ Ê∏¨Ë©¶È†ÖÁõÆ\n\n- [ ] ÂäüËÉΩÂèØÂú®ÈñãÁôºÁí∞Â¢ÉÊ≠£Â∏∏ÈÅã‰Ωú\n\n## üìé ÂÇôË®ª\n\nÊ≠§ PR ÁÇ∫Ëá™ÂãïÂª∫Á´ãÁöÑÊï¥ÂêàÁâàÊú¨`
                });
                
                // ÁÇ∫ DEV PR Ê∑ªÂä† labels
                if (labels.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: devPr.data.number,
                    labels: labels
                  });
                  console.log(`‚úÖ DEV PR #${devPr.data.number} created with labels: ${labels.join(', ')}`);
                } else {
                  console.log(`‚úÖ DEV PR #${devPr.data.number} created`);
                }
              } catch (err) {
                console.log(`‚ö†Ô∏è DEV PR skipped for ${branch}: ${err.message}`);
              }
            }
