name: Auto PR for all unmerged branches

on:
  workflow_dispatch: # ÊâãÂãïËß∏Áôº

permissions:
  contents: write
  pull-requests: write

jobs:
  batch-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all remote branches
        run: git fetch origin

      - name: Find unmerged branches
        id: list
        shell: bash
        run: |
          BRANCHES=$(git branch -r --no-merged origin/dev | grep -v "origin/dev" | grep -v "origin/main" | grep -v "origin/qa" | sed 's|origin/||')
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "üß≠ Unmerged branches:"
          echo "$BRANCHES"

      - name: Create QA and DEV Pull Requests
        if: steps.list.outputs.branches != ''
        uses: actions/github-script@v7
        with:
          script: |
            const branches = `${{ steps.list.outputs.branches }}`.split('\n').filter(Boolean);
            console.log(`üß© Found ${branches.length} branches to process`);

            function formatTitle(branch) {
              const cleaned = branch.replace(/^Feature-/, '')
                                   .replace(/^Fix-/, '')
                                   .replace(/^Update-/, '')
                                   .replace(/-/g, ' ')
                                   .replace(/\b\w/g, c => c.toUpperCase());
              return cleaned.trim();
            }

            for (const branch of branches) {
              const title = formatTitle(branch);
              const qaTitle = `[QA] ${title}`;
              const devTitle = `[DEV] ${title}`;

              console.log(`üöÄ Creating PRs for: ${branch} ‚Üí ${title}`);

              // Âª∫Á´ã QA PR
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: branch,
                base: "qa",
                title: qaTitle,
                body: `Ëá™ÂãïÂª∫Á´ã QA Ê∏¨Ë©¶Áî® PR\n‰æÜÊ∫êÂàÜÊîØÔºö${branch}`
              }).catch(err => console.log(`‚ö†Ô∏è QA PR skipped for ${branch}: ${err.message}`));

              // Âª∫Á´ã DEV PR
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: branch,
                base: "dev",
                title: devTitle,
                body: `Ëá™ÂãïÂª∫Á´ã DEV Êï¥ÂêàÁî® PR\n‰æÜÊ∫êÂàÜÊîØÔºö${branch}`
              }).catch(err => console.log(`‚ö†Ô∏è DEV PR skipped for ${branch}: ${err.message}`));
            }
