name: Auto PR by Selected Branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'åˆ†æ”¯åç¨±ï¼ˆç•™ç©ºå‰‡ä½¿ç”¨ç•¶å‰åˆ†æ”¯ï¼Œæ’é™¤ main, dev, qaï¼‰'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch origin

      - name: List available branches
        run: |
          echo "ğŸ“‹ å¯ç”¨çš„åˆ†æ”¯åˆ—è¡¨ï¼ˆæ’é™¤ main, dev, qaï¼‰ï¼š"
          git branch -r --no-merged origin/dev | grep -v origin/dev | grep -v origin/main | grep -v origin/qa | sed "s|origin/||" | sed 's/^[ \t]*//'

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const { execSync } = require('child_process');
            // å¦‚æœæ²’æœ‰è¼¸å…¥åˆ†æ”¯åç¨±ï¼Œä½¿ç”¨ç•¶å‰è§¸ç™¼ workflow çš„åˆ†æ”¯
            const inputBranch = '${{ github.event.inputs.branch }}'.trim();
            const refBranch = '${{ github.ref_name }}';
            const branch = inputBranch || refBranch;

            console.log(`ğŸ“Œ ä½¿ç”¨åˆ†æ”¯: ${branch}${inputBranch ? ' (æ‰‹å‹•è¼¸å…¥)' : ' (ç•¶å‰åˆ†æ”¯)'}`);


            // é©—è­‰ä¸æ˜¯ä¿è­·åˆ†æ”¯
            if (['main', 'dev', 'qa'].includes(branch)) {
              core.setFailed(`âŒ ä¸å…è¨±é¸æ“‡ ${branch} åˆ†æ”¯`);
              return;
            }

            // æª¢æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            try {
              execSync(`git ls-remote --exit-code origin ${branch}`);
            } catch (e) {
              core.setFailed(`âŒ åˆ†æ”¯ "${branch}" ä¸å­˜åœ¨æ–¼é ç«¯å€‰åº«`);
              return;
            }

            // æ ¹æ“šåˆ†æ”¯åç¨±è¨­å®šæ¨™ç±¤ï¼ˆèˆ‡ auto-pr.yml ç›¸åŒè¦å‰‡ï¼‰
            let labels = [];
            if (branch.startsWith('Feature-')) labels = ['feature', 'enhancement'];
            else if (branch.startsWith('Fix-')) labels = ['bug', 'fix'];
            else if (branch.startsWith('Update-')) labels = ['documentation', 'update'];
            else if (branch.startsWith('Hotfix-')) labels = ['hotfix', 'urgent'];

            // Fetch é ç«¯åˆ†æ”¯ä¸¦æ›´æ–° refs
            execSync(`git fetch origin ${branch}:${branch}`);

            // å–å¾— commit è¨Šæ¯
            const commits = execSync(`git log origin/dev..${branch} --pretty=format:"- %s" --reverse`)
              .toString()
              .trim();

            const prBody = `## Commits\n\n${commits || 'No commit messages available'}`;

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: branch,
                base: 'dev',
                title: `${branch}`,
                body: prBody
              });
              
              console.log(`âœ… æˆåŠŸå»ºç«‹ PR #${pr.data.number}: ${branch} -> dev`);
              
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.data.number,
                  labels: labels
                });
                console.log(`âœ… å·²åŠ å…¥æ¨™ç±¤: ${labels.join(', ')}`);
              }
            } catch (e) {
              if (e.message.includes('A pull request already exists')) {
                console.log(`âš ï¸ PR å·²å­˜åœ¨: ${branch} -> dev`);
              } else {
                core.setFailed(`âŒ å»ºç«‹ PR å¤±æ•—: ${e.message}`);
              }
            }
