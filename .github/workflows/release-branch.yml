name: Create Release Branch

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version type to bump"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-branch:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.next }}
      release_branch: ${{ steps.create_branch.outputs.branch_name }}
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          ref: dev
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # 步驟 1: 獲取當前版本
      - name: Get current version
        id: version
        run: |
          if [ -f package.json ]; then
            VERSION=$(node -p "require('./package.json').version")
          else
            VERSION="0.1.0"
          fi
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          
          # 計算新版本
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          case "${{ github.event.inputs.version_type }}" in
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR+1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH+1))"
              ;;
          esac
          echo "next=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 步驟 2: 更新版本在 package.json
      - name: Update version in package.json
        env:
          NEW_VERSION: ${{ steps.version.outputs.next }}
        run: |
          if [ -f package.json ]; then
            node -e "const pkg = require('./package.json'); pkg.version = '$NEW_VERSION'; require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));"
            echo "✅ Updated package.json to v$NEW_VERSION"
          else
            echo "⚠️ package.json not found"
          fi

      # 步驟 3: 更新 CHANGELOG
      - name: Update CHANGELOG
        env:
          NEW_VERSION: ${{ steps.version.outputs.next }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          cat > /tmp/new_entry.txt << EOF
          ## [$NEW_VERSION] - $TODAY
          
          ### Added
          - New features
          
          ### Fixed
          - Bug fixes
          
          ### Changed
          - Changes
          
          EOF
          
          if [ -f CHANGELOG.md ]; then
            cat /tmp/new_entry.txt CHANGELOG.md > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
            echo "✅ Updated CHANGELOG.md"
          else
            cat /tmp/new_entry.txt > CHANGELOG.md
            echo "✅ Created CHANGELOG.md"
          fi

      # 步驟 4: 建立帶版本號的分支
      - name: Create release branch
        id: create_branch
        env:
          NEW_VERSION: ${{ steps.version.outputs.next }}
        run: |
          # 轉換版本號: 0.2.0 → 020
          BRANCH_SUFFIX=$(echo "$NEW_VERSION" | sed 's/\.//g')
          BRANCH_NAME="dev-v${BRANCH_SUFFIX}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          
          # 只 add 存在的檔案
          git add package.json 2>/dev/null || true
          git add CHANGELOG.md 2>/dev/null || true
          
          # 檢查是否有檔案被 stage
          if git diff --cached --quiet; then
            echo "⚠️ No changes to commit, creating empty commit"
            git commit --allow-empty -m "chore(release): v$NEW_VERSION"
          else
            git commit -m "chore(release): v$NEW_VERSION"
          fi
          
          git push -u origin "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "✅ Created branch: $BRANCH_NAME"

      # 步驟 5: 取得上個版本 tag
      - name: Get last version tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG=$(git rev-list --max-parents=0 HEAD 2>/dev/null || echo "HEAD")
          fi
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      # 步驟 6: 取得自上個版本以來有更新的 Feature/Fix/Update/Hotfix 分支
      - name: Get updated feature branches
        id: branches_list
        env:
          LAST_TAG: ${{ steps.last_tag.outputs.last_tag }}
        run: |
          BRANCHES=""
          
          # 獲取所有遠端分支
          for branch in $(git branch -r --format='%(refname:short)'); do
            # 只處理 Feature-, Fix-, Update-, Hotfix- 開頭的分支
            if [[ "$branch" =~ ^origin/(Feature|Fix|Update|Hotfix)- ]]; then
              CLEAN_BRANCH=$(echo "$branch" | sed 's/^origin\///')
              
              # 檢查這個分支是否在上個版本之後有更新
              if [ "$LAST_TAG" = "HEAD" ]; then
                BRANCHES="$BRANCHES- $CLEAN_BRANCH"$'\n'
              else
                if git log "$LAST_TAG".."$branch" --oneline 2>/dev/null | grep -q .; then
                  BRANCHES="$BRANCHES- $CLEAN_BRANCH"$'\n'
                fi
              fi
            fi
          done
          
          # 如果沒有副分支，就列出主要分支 (dev, qa)
          if [ -z "$BRANCHES" ]; then
            BRANCHES="- dev"$'\n'"- qa"
          else
            # 移除末尾的新行
            BRANCHES=$(echo "$BRANCHES" | sed '$ s/.$//')
          fi
          
          echo "branches<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCHES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 步驟 7: 產生 PR 描述
      - name: Generate PR description
        id: pr_body
        env:
          NEW_VERSION: ${{ steps.version.outputs.next }}
          BRANCHES: ${{ steps.branches_list.outputs.branches }}
        run: |
          VERSION_NUM=$(echo "$NEW_VERSION" | sed 's/\.//g')
          cat > /tmp/pr_body.txt << 'EOF'
          Dev v$VERSION_NUM merge:
          
          $BRANCHES
          EOF
          
          BODY=$(cat /tmp/pr_body.txt)
          BODY="${BODY//\$VERSION_NUM/$VERSION_NUM}"
          BODY="${BODY//\$BRANCHES/$BRANCHES}"
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 步驟 8: 建立 Release PR
      - name: Create Release PR to main
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          commit-message: "chore(release): v${{ steps.version.outputs.next }}"
          title: "Dev v${{ steps.version.outputs.next }}"
          body: ${{ steps.pr_body.outputs.body }}
          branch: ${{ steps.create_branch.outputs.branch_name }}
          base: main
          labels: "release,automation"
          assignees: ${{ github.actor }}
          draft: false
          delete-branch: false

      - name: Notify PR created
        env:
          NEW_VERSION: ${{ steps.version.outputs.next }}
        run: |
          VERSION_NUM=$(echo "$NEW_VERSION" | sed 's/\.//g')
          echo "✅ Release branch created successfully!"
          echo "Branch: ${{ steps.create_branch.outputs.branch_name }}"
          echo "PR Number: ${{ steps.create_pr.outputs.pull-request-number }}"
          echo "Title: Dev v${VERSION_NUM}"
