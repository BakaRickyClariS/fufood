name: Deploy to Production

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: read
  deployments: write

jobs:
  deploy-production:
    if: github.event.pull_request.merged && contains(github.event.pull_request.title, 'Dev v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          ref: main

      - name: Extract version from PR title
        id: extract
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          # æå– vXXX æ ¼å¼
          VERSION_NUM=$(echo "$TITLE" | grep -oP 'v\K[0-9]+' | head -1)
          
          if [ -z "$VERSION_NUM" ]; then
            VERSION="0.0.1"
          else
            # è½‰æ›: v005 â†’ 0.0.5, v020 â†’ 0.2.0, v100 â†’ 1.0.0
            MAJOR=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:0:1} : 0))
            MINOR=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:1:1} : ${VERSION_NUM:0:1}))
            PATCH=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:2} : ${VERSION_NUM:1}))
            
            # è£œé›¶ç¢ºä¿æ­£ç¢ºæ ¼å¼
            MAJOR=$(printf "%d" $MAJOR 2>/dev/null || echo "0")
            MINOR=$(printf "%d" $MINOR 2>/dev/null || echo "0")
            PATCH=$(printf "%d" $PATCH 2>/dev/null || echo "0")
            
            VERSION="$MAJOR.$MINOR.$PATCH"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ”– Extracted version: v$VERSION"

      # ================================================================
      # ä»¥ä¸‹ç‚ºéƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒçš„æ¨¡æ¿
      # æ­£å¼ç’°å¢ƒè¨­å®šé‚„æœªå®Œæˆï¼Œæ•…æš«æ™‚ç¦ç”¨
      # å¾…ç’°å¢ƒå°±ç·’æ™‚ï¼Œè«‹å•Ÿç”¨ä»¥ä¸‹æ­¥é©Ÿ
      # ================================================================

      - name: "[TEMPLATE] Setup Node.js"
        run: |
          echo "â¸ï¸  Production deployment is not yet configured."
          echo "ğŸ“‹ Template steps:"
          echo "   1. Setup Node.js environment"
          echo "   2. Install dependencies"
          echo "   3. Run build process"
          echo "   4. Deploy to production server/CDN"
          echo "   5. Run smoke tests"
          echo "   6. Notify deployment status"

      # ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ç¯„ä¾‹ (å¾…å•Ÿç”¨):
      # - name: Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "18"
      #
      # - name: Install dependencies
      #   run: npm ci
      #
      # - name: Build application
      #   run: npm run build
      #
      # - name: Deploy to production
      #   env:
      #     DEPLOY_SERVER: ${{ secrets.PROD_DEPLOY_SERVER }}
      #     DEPLOY_KEY: ${{ secrets.PROD_DEPLOY_KEY }}
      #     DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
      #   run: |
      #     # éƒ¨ç½²æŒ‡ä»¤ç¯„ä¾‹
      #     # scp -i $DEPLOY_KEY -r dist/* user@$DEPLOY_SERVER:$DEPLOY_PATH
      #     echo "Deploying v${{ steps.extract.outputs.version }} to production..."
      #
      # - name: Run smoke tests
      #   run: |
      #     echo "Running smoke tests..."
      #     # npm run test:smoke
      #
      # - name: Notify deployment success
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.ACTIONS_PAT }}
      #     script: |
      #       await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: context.payload.pull_request.number,
      #         body: `âœ… Production deployment successful!\n\nğŸš€ Version: v${{ steps.extract.outputs.version }}`
      #       });

      - name: Log deployment information
        run: |
          echo "ğŸ“¦ Deployment Information"
          echo "========================"
          echo "Version: v${{ steps.extract.outputs.version }}"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo ""
          echo "â³ Status: Waiting for production environment setup"
          echo "ğŸ“ TODO: Configure production deployment parameters in GitHub Secrets"
          echo "   - PROD_DEPLOY_SERVER"
          echo "   - PROD_DEPLOY_KEY"
          echo "   - PROD_DEPLOY_PATH"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `â¸ï¸ Production deployment v${{ steps.extract.outputs.version }} - Template ready\n\nğŸ“‹ Status: Production environment not yet configured\n\nâœ… Once production environment is ready, enable the deployment steps in the workflow.`
            });
