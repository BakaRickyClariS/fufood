# publish-trigger.yml - è‡ªå‹•ç™¼ä½ˆå·¥ä½œæµ

name: Auto Publish on Release PR Merge

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write

jobs:
  publish-release:
    if: github.event.pull_request.merged && contains(github.event.pull_request.title, 'Dev v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          ref: main

      - name: Extract version from PR title
        id: extract
        run: |
          # å¾ PR æ¨™é¡Œæå–ç‰ˆæœ¬ (Dev v005 â†’ 0.0.5)
          TITLE="${{ github.event.pull_request.title }}"
          
          # æå– vXXX æ ¼å¼
          VERSION_NUM=$(echo "$TITLE" | grep -oP 'v\K[0-9]+' | head -1)
          
          if [ -z "$VERSION_NUM" ]; then
            echo "version=0.0.1" >> $GITHUB_OUTPUT
          else
            # è½‰æ›: v005 â†’ 0.0.5, v020 â†’ 0.2.0, v100 â†’ 1.0.0
            MAJOR=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:0:1} : 0))
            MINOR=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:1:1} : ${VERSION_NUM:0:1}))
            PATCH=$((${#VERSION_NUM} > 2 ? ${VERSION_NUM:2} : ${VERSION_NUM:1}))
            
            # è£œé›¶ç¢ºä¿æ­£ç¢ºæ ¼å¼
            MAJOR=$(printf "%d" $MAJOR 2>/dev/null || echo "0")
            MINOR=$(printf "%d" $MINOR 2>/dev/null || echo "0")
            PATCH=$(printf "%d" $PATCH 2>/dev/null || echo "0")
            
            VERSION="$MAJOR.$MINOR.$PATCH"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ”– Extracted version: v$VERSION"

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.extract.outputs.version }}" -m "Release v${{ steps.extract.outputs.version }}"
          git push origin "v${{ steps.extract.outputs.version }}"
          echo "âœ… Git tag created: v${{ steps.extract.outputs.version }}"

      - name: Read CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # æå–ç¬¬ä¸€å€‹ç‰ˆæœ¬æ¢ç›® (å‰ 30 è¡Œä¸­çš„ç¬¬ 3-30 è¡Œ)
            CHANGELOG=$(head -n 30 CHANGELOG.md | tail -n +3)
          else
            CHANGELOG="ğŸ“¦ Release v${{ steps.extract.outputs.version }}"
          fi

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract.outputs.version }}
          name: Dev v${{ steps.extract.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_PAT }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `âœ… Release v${{ steps.extract.outputs.version }} published successfully!\n\nğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.extract.outputs.version }})`
            });

      - name: Notify success
        run: |
          echo "ğŸ‰ Release published successfully!"
          echo "Version: v${{ steps.extract.outputs.version }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.extract.outputs.version }}"
